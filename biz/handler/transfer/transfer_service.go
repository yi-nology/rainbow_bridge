// Code generated by hertz generator.

package transfer

import (
	"context"
	"errors"
	"io"
	"strings"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/protocol/consts"
	"github.com/yi-nology/rainbow_bridge/biz/handler"
	"github.com/yi-nology/rainbow_bridge/biz/model/api"
	"github.com/yi-nology/rainbow_bridge/biz/service"
)

var svc *service.Service

func SetService(s *service.Service) {
	svc = s
}

// Import .
// @router /api/v1/transfer/import [POST]
func Import(ctx context.Context, c *app.RequestContext) {
	contentType := strings.ToLower(string(c.GetHeader("Content-Type")))
	if strings.HasPrefix(contentType, "multipart/form-data") {
		fileHeader, err := c.FormFile("archive")
		if err != nil {
			handler.RespondError(c, consts.StatusBadRequest, err)
			return
		}
		file, err := fileHeader.Open()
		if err != nil {
			handler.RespondError(c, consts.StatusBadRequest, err)
			return
		}
		defer file.Close()

		data, err := io.ReadAll(file)
		if err != nil {
			handler.RespondError(c, consts.StatusInternalServerError, err)
			return
		}
		overwrite := strings.ToLower(string(c.FormValue("overwrite"))) == "true"
		configs, err := svc.ImportConfigsArchive(handler.EnrichContext(ctx, c), data, overwrite)
		if err != nil {
			handler.RespondError(c, consts.StatusInternalServerError, err)
			return
		}
		handler.RespondOKWithSummary(c, handler.BuildConfigSummary(configs))
		return
	}

	req := &api.ResourceImportRequest{}
	if err := c.BindJSON(req); err != nil {
		handler.RespondError(c, consts.StatusBadRequest, err)
		return
	}
	if len(req.Configs) == 0 {
		handler.RespondError(c, consts.StatusBadRequest, errors.New("configs cannot be empty"))
		return
	}
	if err := svc.ImportConfigs(handler.EnrichContext(ctx, c), req); err != nil {
		handler.RespondError(c, consts.StatusInternalServerError, err)
		return
	}
	handler.RespondOKWithSummary(c, handler.BuildConfigSummary(req.Configs))
}

// Export .
// @router /api/v1/transfer/export [GET]
func Export(ctx context.Context, c *app.RequestContext) {
	// TODO: Batch export功能需要重构以支持environment_key+pipeline_key架构
	// 暂时返回错误提示
	handler.RespondError(c, consts.StatusNotImplemented, errors.New("batch export not yet implemented for new architecture"))
}

// ExportStaticSelected .
// @router /api/v1/transfer/export/static/selected [GET]
func ExportStaticSelected(ctx context.Context, c *app.RequestContext) {
	// TODO: 需要重构以支持新架构
	handler.WriteInternalError(c, errors.New("not yet implemented for new architecture"))
}

// ExportStaticAll .
// @router /api/v1/transfer/export/static/all [GET]
func ExportStaticAll(ctx context.Context, c *app.RequestContext) {
	// TODO: 需要重构以支持新架构
	handler.WriteInternalError(c, errors.New("not yet implemented for new architecture"))
}
