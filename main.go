// Code generated by hertz generator.

package main

import (
	"context"
	"embed"
	"io/fs"
	"log"

	app "github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/app/server"
	"github.com/yi-nology/rainbow_bridge/biz/handler"
	handlerpb "github.com/yi-nology/rainbow_bridge/biz/handler/resourcepb"
	resourcemodel "github.com/yi-nology/rainbow_bridge/biz/model/resource"
	bizrouter "github.com/yi-nology/rainbow_bridge/biz/router"
	routerpb "github.com/yi-nology/rainbow_bridge/biz/router/resourcepb"
	resourceservice "github.com/yi-nology/rainbow_bridge/biz/service/resource"
	"github.com/yi-nology/rainbow_bridge/pkg/config"
	"github.com/yi-nology/rainbow_bridge/pkg/database"
)

//go:embed web/*
var embeddedWeb embed.FS

func main() {
	cfg, err := config.Load("config.yaml")
	if err != nil {
		log.Fatalf("load config: %v", err)
	}

	db, err := database.Open(cfg.Database)
	if err != nil {
		log.Fatalf("open database: %v", err)
	}

	if err := db.AutoMigrate(&resourcemodel.Config{}, &resourcemodel.Asset{}); err != nil {
		log.Fatalf("auto migrate: %v", err)
	}

	if err := resourceservice.EnsureSystemDefaults(context.Background(), db); err != nil {
		log.Fatalf("seed system defaults: %v", err)
	}

	h := server.Default(server.WithHostPorts(cfg.Server.Address))

	resourceService := resourceservice.NewService(db)
	resourceHandler := handler.NewResourceHandler(resourceService)
	pbHandler := handlerpb.NewResourceService(resourceService)
	routerpb.SetResourceServiceHandler(pbHandler)

	bizrouter.GeneratedRegister(h)
	bizrouter.RegisterResourceRoutes(h, resourceHandler)

	webFS, err := fs.Sub(embeddedWeb, "web")
	if err != nil {
		log.Fatalf("prepare web assets: %v", err)
	}
	registerStaticRoutes(h, webFS)

	log.Printf("server listening at %s", cfg.Server.Address)
	h.Spin()
}

func registerStaticRoutes(h *server.Hertz, fsys fs.FS) {
	serve := func(route, file, contentType string) {
		h.GET(route, func(ctx context.Context, c *app.RequestContext) {
			data, err := fs.ReadFile(fsys, file)
			if err != nil {
				c.Response.SetStatusCode(404)
				c.Write([]byte("Not Found"))
				return
			}
			if contentType != "" {
				c.Response.Header.Set("Content-Type", contentType)
			}
			c.Write(data)
		})
	}

	serve("/", "home.html", "text/html; charset=utf-8")
	serve("/home", "home.html", "text/html; charset=utf-8")
	serve("/home.html", "home.html", "text/html; charset=utf-8")
	serve("/index", "index.html", "text/html; charset=utf-8")
	serve("/index.html", "index.html", "text/html; charset=utf-8")
	serve("/system", "system.html", "text/html; charset=utf-8")
	serve("/system.html", "system.html", "text/html; charset=utf-8")
	serve("/assets", "assets.html", "text/html; charset=utf-8")
	serve("/assets.html", "assets.html", "text/html; charset=utf-8")
	serve("/export", "export.html", "text/html; charset=utf-8")
	serve("/export.html", "export.html", "text/html; charset=utf-8")
	serve("/import", "import.html", "text/html; charset=utf-8")
	serve("/import.html", "import.html", "text/html; charset=utf-8")
	serve("/styles.css", "styles.css", "text/css; charset=utf-8")
	serve("/config.js", "config.js", "application/javascript")
	serve("/assets.js", "assets.js", "application/javascript")
	serve("/export.js", "export.js", "application/javascript")
	serve("/import.js", "import.js", "application/javascript")
	serve("/home.js", "home.js", "application/javascript")
	serve("/components.js", "components.js", "application/javascript")
	serve("/ui.js", "ui.js", "application/javascript")
	serve("/system.js", "system.js", "application/javascript")
}
